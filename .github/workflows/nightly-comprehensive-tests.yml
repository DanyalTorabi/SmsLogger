name: Nightly Comprehensive Tests

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  comprehensive-test-suite:
    name: Run Comprehensive Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        api-level: [23, 26, 29, 33]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run unit tests
      run: ./gradlew testDebugUnitTest

    - name: Set up Android emulator
      uses: ReactiveCircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        arch: x86_64
        profile: pixel
        script: echo "Emulator started"
        
    - name: Run Android tests
      uses: ReactiveCircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        script: ./gradlew connectedDebugAndroidTest

    - name: Run UI tests
      uses: ReactiveCircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        script: ./gradlew executeScreenshotTests

    - name: Generate combined coverage report
      run: ./gradlew jacocoTestReport

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nightly-test-results-api${{ matrix.api-level }}
        path: |
          app/build/test-results/
          app/build/outputs/androidTest-results/
          app/build/reports/tests/
        retention-days: 30

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: nightly-coverage-reports-api${{ matrix.api-level }}
        path: app/build/reports/jacoco/
        retention-days: 30

    - name: Upload UI test screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-screenshots-api${{ matrix.api-level }}
        path: app/build/outputs/screenshotTest/
        retention-days: 30

    - name: Verify coverage thresholds
      run: ./gradlew jacocoTestCoverageVerification

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          app/build/test-results/**/*.xml
          app/build/outputs/androidTest-results/**/*.xml
        
  notify-results:
    name: Notify Test Results
    needs: comprehensive-test-suite
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check comprehensive test results
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = "${{ needs.comprehensive-test-suite.result }}";
            const emoji = outcome === 'success' ? '✅' : '❌';
            const message = `${emoji} Nightly comprehensive tests: ${outcome}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 26,
              body: message
            });
